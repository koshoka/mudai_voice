# 次回のアクション

**最終更新**: 2025-10-04
**現在の状態**: Phase 4完了・実機テスト準備完了

---

## 優先度1: 実機テスト（Phase 3-4の動作確認）

### 目的
Phase 3（WhisperKit統合）とPhase 4（UX改善）の実装が完了したため、マイクを使用した実機テストを実施する。

### 前提条件
- マイクが接続されている
- WhisperKitの初回モデルダウンロードには時間がかかる
  - Small: 約500MB
  - Medium: 約1.5GB
  - 安定したインターネット接続が必要

### テスト手順

#### テスト1: 基本的な録音・文字起こしフロー

1. **アプリ起動**
   ```bash
   # Xcodeから実行
   ⌘+R
   ```

2. **設定確認**
   - メニューバー → 設定
   - 「自動文字起こし」がONになっているか確認
   - Whisperモデル: まずは「Small」で試す（軽量・高速）

3. **録音実施**
   - メニューバー → 録音開始（または Option + P）
   - 日本語で話す（例: 「これはテストです。今日は良い天気です。」）
   - 5〜10秒程度録音
   - メニューバー → 録音停止（または Option + P）

4. **確認ポイント**
   - [ ] メニューバーアイコンがパルスアニメーションする（Phase 4）
   - [ ] 「録音完了」通知が表示される（録音時間・ファイルサイズ付き）（Phase 4）
   - [ ] 数秒〜数十秒後に「文字起こし完了」通知が表示される（文字数付き）（Phase 4）
   - [ ] 通知から「ファイルを開く」または「Finderで表示」をクリック
   - [ ] .mdファイルが正しく開く（Phase 3修正）
   - [ ] 文字起こしテキストが表示される
   - [ ] メニューバーから「最後の文字起こしを開く」が動作する（Phase 3修正）

#### テスト2: Whisperモデルの比較

1. 設定画面でWhisperモデルを「Medium」に変更
2. 同じ内容を録音
3. 精度の違いを確認
4. 処理時間の違いを確認

#### テスト3: 英語の文字起こし

1. 英語で録音（例: "This is a test. The weather is nice today."）
2. 文字起こし結果を確認
3. 精度を評価

#### テスト4: Phase 4機能の確認

1. **エラーハンドリング**
   - マイク権限を拒否した状態で録音を試みる
   - 詳細なエラーメッセージと「システム設定を開く」ボタンが表示されることを確認

2. **通知からの削除機能**
   - 録音完了通知から「削除」をクリック
   - 確認ダイアログが表示されることを確認
   - 削除後、削除完了通知が表示されることを確認

3. **アニメーション**
   - 録音中にメニューバーアイコンが滑らかにパルスすることを確認
   - 録音停止後、アニメーションが停止することを確認

### トラブルシューティング

#### 初回実行時のモデルダウンロード

もし処理が長時間かかる場合:
- Console.appでログを確認
  - フィルタ: "VoiceCapture"
  - "Downloading model" などのメッセージを確認
- ネットワーク接続を確認
- 初回のみ10〜30分かかる可能性あり

#### 文字起こし失敗時

確認すべき点:
- [ ] macOS 15.0以降を使用しているか
- [ ] ディスク容量は十分か（モデル分 + 録音ファイル分）
- [ ] マイク権限が許可されているか
- [ ] Console.appでエラーログを確認
- [ ] 詳細なエラーアラートが表示されているか（Phase 4実装）

---

## 優先度2: テスト作成（任意）

### 目的
コードの品質と保守性を向上させるため、自動テストを作成する。

### ユニットテスト

テスト対象:
- RecordingViewModel
- TranscriptionViewModel
- AudioRecordingService（モック使用）
- FileStorageService
- NotificationService

### 統合テスト

テストシナリオ:
- 録音開始→停止→ファイル保存フロー
- 録音→文字起こし→Markdown保存フロー
- パーミッションエラーハンドリング
- 通知からのアクション実行

### 所要時間
4〜6時間

### 優先度判断
**推奨**: 実機テスト完了後、必要性を感じた場合に実施

---

## 優先度3: マイク選択機能の実装（将来対応）

### 現状
- UI表示のみ
- 実際の録音には反映されない
- 理由: AVAudioRecorderは特定デバイス指定に非対応

### 実装に必要なこと

#### ステップ1: AudioRecordingServiceのリファクタリング

変更内容:
```
AVAudioRecorder ベース
↓
AVAudioEngine + AVCaptureDevice ベース
```

影響範囲:
- AudioRecordingService.swift 全体
- 録音処理の完全な書き換え
- テストの再実施

推定工数: 4〜6時間

#### ステップ2: テスト実施

確認項目:
- [ ] デフォルトマイクでの録音
- [ ] 外部マイクでの録音
- [ ] iPhone Mirroring経由のマイク
- [ ] 音質の確認
- [ ] ファイルサイズの比較

### 優先度判断

**推奨**: 実機テスト完了後、必要性を感じた場合に実施

理由:
- 現在の録音機能は正常動作している
- マイク選択は「あると便利」だが必須ではない
- 実機テストで優先度を再評価すべき

---

## 参考: Phase 4完了時点での状態

### 実装完了機能（Phase 1-4）

**Phase 1: 基本録音機能**
- ✅ 録音開始/停止、WAV保存
- ✅ 通知機能
- ✅ 権限管理（マイク・通知）

**Phase 2: ホットキーと設定**
- ✅ グローバルホットキー（Option + P）
- ✅ 設定画面UI（音質、保存先、Whisperモデル選択）
- ✅ マイク選択UI（表示のみ）

**Phase 3: WhisperKit統合**
- ✅ WhisperKit統合（Small/Medium選択可能）
- ✅ TranscriptionService完全実装
- ✅ 自動文字起こしワークフロー
- ✅ Markdown出力機能
- ✅ 文字起こしファイルを開く機能（修正済み）

**Phase 4: UX改善**
- ✅ 録音中パルスアニメーション
- ✅ リッチ通知（録音時間・ファイルサイズ・文字数表示）
- ✅ エラーハンドリング強化（詳細メッセージ、回復提案、システム設定へのショートカット）
- ✅ 通知からのファイル削除機能（確認ダイアログ付き）

### 動作確認済み（ビルドテスト）
- ✅ ビルド成功（Phase 1-4すべて）
- ✅ 設定画面のUI表示
- ✅ メニューバー常駐

### 未確認（マイク不在のため）
- ⏸ 実際の録音動作
- ⏸ 文字起こし動作
- ⏸ Whisperモデルダウンロード
- ⏸ 文字起こし精度
- ⏸ パフォーマンス
- ⏸ アニメーション・通知の実動作
- ⏸ Phase 3修正（文字起こしファイルを開く）の実動作
- ⏸ Phase 4機能の実動作

### 既知の制限事項
- ⚠️ マイク選択がUI表示のみ（実録音には反映されない - AVAudioEngine化が必要）

---

## 次回の作業開始時のチェックリスト

### 準備
- [ ] `/Users/kk/development/mudai_voice/PROGRESS.md` を確認
- [ ] このファイル（NEXT_STEPS.md）を確認
- [ ] Xcodeでプロジェクトを開く
- [ ] マイクを接続（実機テストする場合）
- [ ] 安定したインターネット接続を確保（Whisperモデルダウンロード用）

### 推奨作業順序
1. **実機テスト**（1〜2時間、モデルDL込み）
   - Phase 3-4の全機能を実際に動作確認
   - バグや改善点があれば記録

2. **バグ修正・調整**（必要に応じて）
   - 実機テストで見つかった問題を修正

3. **テスト作成またはマイク選択機能実装**（任意）
   - 品質向上または機能拡張

### いつでも確認できる情報
- **詳細な進捗**: `/Users/kk/development/mudai_voice/PROGRESS.md`
- **コミット履歴**: `git log --oneline`

---

**最後のコミット**: `330dd62 - feat: Phase 3修正完了・Phase 4 UX改善実装完了`
